import { tempDirectory } from "./utils/fileSystemUtils";
import "dotenv/config";
import { installToolsBasedOnOS } from "./installToolsOnOS";
import * as tl from "azure-pipelines-task-lib/task";

export async function main(usecase: string = ""): Promise<number> {
  try {
    const tempDirectoryPath = tempDirectory();
    console.log("using path ", tempDirectoryPath);
    const configFilePath = await installToolsBasedOnOS(
      tempDirectoryPath,
      usecase
    );
    if (usecase != "gpg-signing") {
      console.info("PKCS11 config file written in path: ", configFilePath);
      tl.setVariable("PKCS11_CONFIG", configFilePath, false, true);
      console.info("PKCS11 config file written in path: ", configFilePath);
    }
    console.log("SSM tools setup completed");
    return 0;
  } catch (err: any) {
    console.error("error when executing setup task of SSM", err);
    return 1;
  }
}

module.exports = { main };
